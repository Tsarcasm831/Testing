<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Konoha Map — districts, roads, move, delete, export</title>
<style>
  :root{
    --bg:#0e0e0e;--ink:#eaeaea;--panel:#0b0b0bcc;
    --dist-stroke:#22d3ee;--dist-fill:#22d3ee55;
    --poi:#f59e0b;--gate:#ef4444;--park:#22c55e;--letter:#a78bfa;
    --roadA:#f8fafc;--roadS:#cbd5e1;--canal:#38bdf8;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:13.5px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #wrap{height:100%;display:grid;grid-template-columns:minmax(0,1fr) 348px}
  #mapPane{position:relative;overflow:hidden}
  svg{width:100%;height:100%;display:block;touch-action:none}
  /* layers */
  .district{fill:var(--dist-fill);stroke:var(--dist-stroke);stroke-width:2;vector-effect:non-scaling-stroke}
  .district:hover{stroke:#fff}
  .road{fill:none;stroke-linecap:round;stroke-linejoin:round;vector-effect:non-scaling-stroke}
  .road.avenue{stroke:var(--roadA)}
  .road.street{stroke:var(--roadS)}
  .road.canal{stroke:var(--canal)}
  .pin{fill:var(--poi);stroke:#000;stroke-width:1.1}
  .pin.gate{fill:var(--gate)} .pin.park{fill:var(--park)} .pin.letter{fill:var(--letter)}
  .lbl{font:700 10px ui-monospace,SFMono-Regular,Consolas;text-anchor:middle;fill:#0b0b0b}
  .selected{filter:drop-shadow(0 0 6px #fff9)}
  /* edit handles */
  .handle{fill:#fff;stroke:#111;stroke-width:1.1;cursor:grab}
  .handle:active{cursor:grabbing}
  .ghost{stroke-dasharray:6 4;opacity:.8}
  /* tooltip */
  #tip{position:absolute;pointer-events:none;z-index:9;min-width:220px;max-width:min(360px,44vw);
    background:rgba(0,0,0,.78);backdrop-filter:blur(6px);border:1px solid #333;border-radius:12px;
    padding:10px 12px;transform:translate(10px,10px);box-shadow:0 8px 22px #000a}
  #tip h3{margin:.1rem 0 .3rem;font-size:14px}
  #tip p{margin:.25rem 0;font-size:12px;opacity:.95}
  /* side panel */
  #side{background:var(--panel);border-left:1px solid #222;padding:12px;overflow:auto}
  #side h2{margin:.2rem 0 .6rem;font-size:16px}
  fieldset{border:1px solid #2a2a2a;border-radius:10px;padding:8px;margin:.5rem 0}
  legend{opacity:.85;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;margin:.25rem 0;flex-wrap:wrap}
  label{display:flex;align-items:center;gap:.35rem}
  input[type="text"], select, input[type="number"]{
    background:#0f0f0f;border:1px solid #333;border-radius:8px;color:#e5e7eb;padding:6px 8px;font:12px system-ui
  }
  button{background:#121212;border:1px solid #333;border-radius:10px;color:#eaeaea;padding:8px 10px;font:600 12px system-ui;cursor:pointer}
  button.primary{border-color:#4f46e5}
  #json{width:100%;min-height:160px;background:#0f0f0f;border:1px solid #222;color:#cbd5e1;border-radius:10px;padding:8px;font:12px ui-monospace,SFMono-Regular,Consolas}
  @media (max-width:980px){#wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="wrap">
  <div id="mapPane">
    <svg id="map" viewBox="0 0 1018 968" aria-label="Konohagakure interactive map">
      <image href="konohagakure.jpg" x="0" y="0" width="1018" height="968" preserveAspectRatio="xMidYMid slice"></image>
      <!-- Layers order: roads below districts for readability; pins on top -->
      <g id="roadLayer"></g>
      <g id="districtLayer"></g>
      <g id="poiLayer"></g>
      <g id="handleLayer"></g>
    </svg>
    <div id="tip" hidden></div>
  </div>

  <aside id="side">
    <h2>Konoha Map — Editor</h2>

    <fieldset>
      <legend>Mode</legend>
      <div class="row">
        <label><input type="radio" name="mode" value="select" checked> Select / Move</label>
        <label><input type="radio" name="mode" value="draw-district"> Draw District</label>
        <label><input type="radio" name="mode" value="draw-road"> Draw Road</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="snap"> Snap 1% grid</label>
        <label><input type="checkbox" id="edit"> Edit overlay (handles)</label>
        <label><input type="checkbox" id="autosave" checked> Autosave</label>
      </div>
      <div class="row" style="opacity:.8">Tips: drag vertices. <b>Alt+drag</b> to move whole road/district. <b>Esc</b> cancel, <b>Enter</b> or double-click finish.</div>
    </fieldset>

    <fieldset>
      <legend>Layers</legend>
      <div class="row">
        <label><input type="checkbox" id="toggleDistricts" checked> Districts</label>
        <label><input type="checkbox" id="toggleRoads" checked> Roads</label>
        <label><input type="checkbox" id="togglePOI" checked> POIs</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Selected</legend>
      <div id="selNone" class="row" style="opacity:.7">Nothing selected.</div>
      <div id="selForm" hidden>
        <div class="row"><label>Type <input id="sType" type="text" readonly></label></div>
        <div class="row">
          <label>ID <input id="sId" type="text"></label>
          <label>Name <input id="sName" type="text" size="22"></label>
        </div>
        <div class="row"><label style="flex:1">Description <input id="sDesc" type="text" style="width:100%"></label></div>
        <div id="roadExtras" class="row" hidden>
          <label>Road type
            <select id="sRoadType">
              <option value="avenue">avenue</option>
              <option value="street">street</option>
              <option value="canal">canal</option>
            </select>
          </label>
          <label>Width <input id="sRoadW" type="number" min="1" max="24" step="1" value="6">px</label>
        </div>
        <div class="row">
          <button id="apply" class="primary">Apply</button>
          <button id="delete">Delete selected</button>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Export / Import</legend>
      <div class="row">
        <button id="copyJson">Copy JSON</button>
        <button id="downloadJson" class="primary">Download JSON</button>
        <button id="exportSvg">Export SVG Overlay</button>
      </div>
      <div class="row">
        <input type="file" id="importFile" accept="application/json">
        <button id="loadAutosave">Load Autosave</button>
        <button id="clearAll">Clear All</button>
      </div>
      <textarea id="json" readonly></textarea>
    </fieldset>

    <p style="opacity:.65">Shortcuts: <b>E</b> toggle Edit, <b>H</b> hide panel.</p>
  </aside>
</div>

<script>
/* =================== Model =================== */
const W=1018,H=968; // viewBox
const svg = document.getElementById('map');
const dLayer = document.getElementById('districtLayer');
const rLayer = document.getElementById('roadLayer');
const pLayer = document.getElementById('poiLayer');
const hLayer = document.getElementById('handleLayer');
const tip = document.getElementById('tip');
const out = document.getElementById('json');
const $ = sel => document.querySelector(sel);

const MODEL = {
  districts: {
    // Auto-traced polygons from your last fix
    hyuuga:{
      id:'hyuuga', name:'Hyuuga District', desc:'Walled compounds and courtyards in the northeast wards.',
      points:[[99.92,20.21],[96.43,22.15],[95.34,24.55],[95.57,26.53],[94.47,32.48],[91.34,36.03],[95.73,40.66],[96.0,42.93],[95.57,40.74],[91.22,36.32],[87.58,37.69],[88.09,38.97],[88.52,38.93],[88.87,37.4],[89.3,37.52],[89.18,38.22],[90.13,39.16],[88.21,39.49],[87.58,38.55],[87.95,37.36],[86.74,37.24],[86.87,37.9],[86.46,38.51],[85.44,38.35],[85.28,37.94],[84.6,37.57],[83.96,37.73],[83.91,38.47],[83.33,38.01],[82.92,37.2],[82.38,36.99],[82.34,36.31],[81.98,35.7],[81.47,35.27],[81.57,36.17],[81.07,36.93],[80.58,36.99],[80.24,36.69],[79.86,36.1],[78.7,35.16],[78.18,33.61],[77.82,31.65],[77.87,29.94],[78.19,28.44],[78.84,26.92],[79.71,25.64],[81.01,24.49],[83.21,23.55],[85.94,23.14],[88.52,23.37],[91.14,23.93],[92.72,24.76],[94.1,25.83],[95.29,26.18],[95.34,24.55],[96.43,22.15],[99.92,20.21]]
    },
    inuzuka:{
      id:'inuzuka', name:'Inuzuka District', desc:'Kennels and waterways along the eastern wards.',
      points:[[87.23,62.02],[83.39,59.71],[83.15,61.12],[82.52,61.53],[81.7,61.24],[81.17,60.54],[80.88,59.52],[80.49,58.4],[79.87,57.52],[79.76,55.92],[79.65,54.13],[79.77,52.52],[80.21,50.84],[81.01,49.48],[82.06,48.26],[83.53,47.33],[85.13,46.72],[86.78,46.69],[88.3,46.91],[89.73,47.41],[91.07,48.08],[92.38,48.94],[93.74,50.27],[94.55,51.91],[95.18,53.65],[95.58,55.59],[95.7,57.58],[95.55,59.44],[95.04,61.19],[94.16,62.64],[92.99,63.78],[91.53,64.54],[90.06,64.87],[88.69,64.64],[87.23,62.02]]
    },
    akimichi:{
      id:'akimichi', name:'Akimichi District', desc:'South-east residential and storehouse blocks.',
      points:[[62.39,63.89],[62.03,62.64],[62.02,61.07],[62.7,59.72],[64.0,58.52],[65.59,57.62],[67.32,57.06],[69.18,56.8],[71.15,56.89],[73.16,57.4],[74.95,58.38],[76.32,59.74],[77.17,61.34],[77.51,63.11],[77.42,65.07],[76.91,66.93],[76.0,68.51],[74.66,69.82],[73.1,70.71],[71.35,71.06],[69.58,70.91],[67.86,70.29],[66.34,69.29],[65.12,67.96],[64.13,66.45],[63.26,65.1],[62.39,63.89]]
    },
    nara:{
      id:'nara', name:'Nara District', desc:'Scholarly quarter and archives in the south-east.',
      points:[[73.86,83.24],[72.07,82.57],[70.62,81.53],[69.41,80.14],[68.53,78.54],[68.12,76.74],[68.17,74.87],[68.79,73.16],[69.94,71.52],[71.43,70.43],[73.19,69.94],[75.03,69.92],[76.73,70.39],[78.27,71.37],[79.48,72.82],[80.21,74.54],[80.45,76.42],[80.22,78.27],[79.49,79.95],[78.3,81.34],[76.76,82.36],[75.05,82.97],[73.86,83.24]]
    },
    yamanaka:{
      id:'yamanaka', name:'Yamanaka District', desc:'Florists and family homes near the south gate.',
      points:[[63.22,94.47],[61.32,93.77],[59.92,92.5],[58.92,90.95],[58.59,89.13],[58.89,87.33],[59.91,85.86],[61.42,84.77],[63.28,84.25],[65.25,84.22],[67.11,84.78],[68.67,85.93],[69.79,87.55],[70.28,89.45],[70.12,91.31],[69.35,92.98],[67.99,94.25],[66.24,94.93],[64.67,95.02],[63.22,94.47]]
    },
    aburame:{
      id:'aburame', name:'Aburame District', desc:'South-west quarter by the canal and gardens.',
      points:[[0.39,86.49],[2.01,85.77],[7.08,85.07],[8.62,84.47],[9.6,83.39],[10.51,80.51],[12.39,78.17],[14.84,76.28],[18.37,74.81],[19.07,74.7],[19.0,75.29],[20.64,79.2],[22.52,80.62],[24.91,81.46],[27.59,80.7],[30.34,78.54],[32.28,75.58],[33.37,72.03],[33.26,68.08],[31.99,65.23],[29.87,63.66],[27.18,63.28],[24.24,64.15],[21.59,65.93],[19.86,68.28],[18.84,70.63],[18.46,72.52],[19.36,74.59],[19.16,75.04],[20.81,79.09],[22.49,80.62],[20.65,79.17],[19.0,75.29],[19.08,74.63],[18.42,74.75],[14.97,76.24],[12.46,78.06],[10.54,80.5],[9.6,83.39],[8.62,84.5],[7.29,85.08],[1.65,85.74],[0.39,86.49]]
    }
  },
  roads: [
    // start blank; draw your own
    // Example:
    // {id:'main-avenue-ns', name:'Main Avenue N–S', type:'avenue', width:8, points:[[50,9],[50,92.7]]}
  ],
  poi: [
    {id:'gate-n',name:'North Gate',type:'gate',x:50.0,y:8.9,desc:'Northern entrance.'},
    {id:'gate-e',name:'East Gate',type:'gate',x:93.7,y:50.0,desc:'Eastern entrance.'},
    {id:'gate-s',name:'South Gate',type:'gate',x:50.0,y:92.7,desc:'Southern entrance.'},
    {id:'gate-w',name:'West Gate', type:'gate',x:8.9, y:50.0,desc:'Western entrance.'},
    {id:'A',name:'A — Fire Plaza / Market I',type:'letter',x:50.0,y:14.6,desc:'Civic plaza.'},
    {id:'B',name:'B — Market II (Central)', type:'letter',x:50.0,y:50.0,desc:'Central market.'},
    {id:'C1',name:'C — Parklands (West Lake)',type:'park',x:45.2,y:64.6,desc:'Lakeside park.'},
    {id:'C2',name:'C — Parklands (East Channel)',type:'park',x:71.6,y:57.9,desc:'Riverside paths.'},
    {id:'C3',name:'C — Neighborhood Park (NW)',type:'park',x:29.5,y:44.4,desc:'Inner-ward park.'},
    {id:'D', name:'D — Cemetery & Memorial',type:'park',x:23.6,y:82.6,desc:'Memorial stone grounds.'}
  ]
};

/* =================== State =================== */
const state = {
  mode:'select', edit:false, snap:false,
  selected:null, // {kind:'district'|'road'|'poi', key:string|index}
  drawing:null,  // {kind:'district'|'road', points:[[x,y],...]}
};

/* =================== Helpers =================== */
const pct = n => `${n}%`;
const clamp=(v,min,max)=>v<min?min:v>max?max:v;
const screenToPct=(clientX,clientY)=>{
  const pt=svg.createSVGPoint(); pt.x=clientX; pt.y=clientY;
  const p=pt.matrixTransform(svg.getScreenCTM().inverse());
  let x=(p.x/W)*100, y=(p.y/H)*100;
  if(state.snap){ x=Math.round(x); y=Math.round(y); }
  return [clamp(+x.toFixed(2),0,100), clamp(+y.toFixed(2),0,100)];
};
const mk=(tag,attrs={},children=[])=>{
  const el=document.createElementNS('http://www.w3.org/2000/svg',tag);
  for(const k in attrs) el.setAttribute(k,attrs[k]);
  for(const c of children) el.append(c instanceof Node?c:document.createTextNode(c));
  return el;
};
const download=(name, text, type='application/json')=>{
  const blob=new Blob([text],{type}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
};
const autosave=()=>{ if($('#autosave').checked){ localStorage.setItem('konoha-map', JSON.stringify(MODEL)); } };

/* =================== Rendering =================== */
function drawAll(){
  drawRoads(); drawDistricts(); drawPOI(); drawHandles(); updateForm(); dumpJSON(); autosave();
}
function drawDistricts(){
  dLayer.innerHTML='';
  if(!$('#toggleDistricts').checked) return;
  for(const k in MODEL.districts){
    const d=MODEL.districts[k];
    const pts=d.points.map(([x,y])=>[x*W/100,y*H/100].join(',')).join(' ');
    const poly=mk('polygon',{class:'district '+(isSelected('district',k)?'selected':''),'data-id':k,points:pts});
    poly.addEventListener('mouseenter',e=>showTip(e,{name:d.name,desc:d.desc}));
    poly.addEventListener('mousemove',moveTip);
    poly.addEventListener('mouseleave',hideTip);
    poly.addEventListener('mousedown',e=>{
      if(state.mode==='select'){ select('district',k); if(e.altKey){ startDragWhole(e,'district',k);} }
      if(state.mode==='draw-district'){ /* allow continue adding via handles only */ }
    });
    dLayer.append(poly);
  }
}
function drawRoads(){
  rLayer.innerHTML='';
  if(!$('#toggleRoads').checked) return;
  for(let i=0;i<MODEL.roads.length;i++){
    const r=MODEL.roads[i];
    const d=r.points.map(p=>[p[0]*W/100,p[1]*H/100].join(',')).join(' ');
    const pl=mk('polyline',{class:`road ${r.type} ${isSelected('road',i)?'selected':''}`,
        'data-i':i, points:d, strokeWidth:r.width||6});
    pl.addEventListener('mouseenter',e=>showTip(e,{name:r.name||r.id||'road',desc:r.type+` (${r.width||6}px)`}));
    pl.addEventListener('mousemove',moveTip);
    pl.addEventListener('mouseleave',hideTip);
    pl.addEventListener('mousedown',e=>{
      if(state.mode==='select'){ select('road',i); if(e.altKey){ startDragWhole(e,'road',i);} }
    });
    rLayer.append(pl);
  }
}
function drawPOI(){
  pLayer.innerHTML='';
  if(!$('#togglePOI').checked) return;
  for(let i=0;i<MODEL.poi.length;i++){
    const p=MODEL.poi[i];
    const g=mk('g',{'data-i':i});
    const r = p.type==='gate'?1.8:(p.type==='park'?2.2:(p.type==='letter'?2.4:2.2));
    const c=mk('circle',{class:`pin ${p.type}`,cx:pct(p.x),cy:pct(p.y),r:pct(r)});
    const t=mk('text',{class:'lbl',x:pct(p.x),y:`calc(${pct(p.y)} + .35%)`}, p.type==='letter'?p.id:(p.type==='park'?(p.id.startsWith('C')?'C':'D'):(p.type==='gate'?'G':'●')));
    g.append(c,t);
    g.addEventListener('mouseenter',e=>showTip(e,p));
    g.addEventListener('mousemove',moveTip);
    g.addEventListener('mouseleave',hideTip);
    g.addEventListener('mousedown',e=>{
      if(state.mode==='select'){ select('poi',i); startDragPOI(e,i); }
    });
    if(isSelected('poi',i)) g.classList.add('selected');
    pLayer.append(g);
  }
}
function drawHandles(){
  hLayer.innerHTML='';
  if(!state.edit || !state.selected) return;
  if(state.selected.kind==='district'){
    const d=MODEL.districts[state.selected.key];
    d.points.forEach(([x,y],idx)=>{
      const h=mk('circle',{class:'handle',r:6,cx:x*W/100,cy:y*H/100,'data-i':idx});
      h.addEventListener('mousedown',e=>startDragVertex(e,'district',state.selected.key,idx));
      hLayer.append(h);
    });
  } else if(state.selected.kind==='road'){
    const r=MODEL.roads[state.selected.key];
    r.points.forEach(([x,y],idx)=>{
      const h=mk('circle',{class:'handle',r:6,cx:x*W/100,cy:y*H/100,'data-i':idx});
      h.addEventListener('mousedown',e=>startDragVertex(e,'road',state.selected.key,idx));
      hLayer.append(h);
    });
  }
}

/* =================== Selection & dragging =================== */
function isSelected(kind,key){ return state.selected && state.selected.kind===kind && state.selected.key===key; }
function select(kind,key){ state.selected={kind,key}; drawAll(); }
function startDragVertex(e,kind,key,idx){
  e.preventDefault();
  const move=(ev)=>{
    const [x,y]=screenToPct(ev.clientX,ev.clientY);
    if(kind==='district') MODEL.districts[key].points[idx]=[x,y];
    else MODEL.roads[key].points[idx]=[x,y];
    drawAll();
  };
  const up=()=>{window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up);};
  window.addEventListener('mousemove',move); window.addEventListener('mouseup',up,{once:true});
}
function startDragWhole(e,kind,key){
  e.preventDefault();
  const ref=screenToPct(e.clientX,e.clientY);
  const move=(ev)=>{
    const [nx,ny]=screenToPct(ev.clientX,ev.clientY);
    const dx=nx-ref[0], dy=ny-ref[1];
    if(kind==='district'){
      MODEL.districts[key].points = MODEL.districts[key].points.map(([x,y])=>[clamp(+((x+dx)).toFixed(2),0,100), clamp(+((y+dy)).toFixed(2),0,100)]);
    }else{
      MODEL.roads[key].points = MODEL.roads[key].points.map(([x,y])=>[clamp(+((x+dx)).toFixed(2),0,100), clamp(+((y+dy)).toFixed(2),0,100)]);
    }
    drawAll();
  };
  const up=()=>{window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up);};
  window.addEventListener('mousemove',move); window.addEventListener('mouseup',up,{once:true});
}
function startDragPOI(e,i){
  e.preventDefault();
  const move=(ev)=>{
    const [x,y]=screenToPct(ev.clientX,ev.clientY);
    MODEL.poi[i].x=x; MODEL.poi[i].y=y; drawAll();
  };
  const up=()=>{window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up);};
  window.addEventListener('mousemove',move); window.addEventListener('mouseup',up,{once:true});
}

/* =================== Drawing tools =================== */
svg.addEventListener('dblclick',finishDrawing);
svg.addEventListener('mousedown',canvasDown);
window.addEventListener('keydown',e=>{
  if(e.key==='Escape') cancelDrawing();
  if(e.key==='Enter') finishDrawing();
  if(e.key.toLowerCase()==='e'){ $('#edit').click(); }
  if(e.key.toLowerCase()==='h'){ document.querySelector('#wrap').style.gridTemplateColumns=
      getComputedStyle(document.querySelector('#wrap')).gridTemplateColumns==='1fr 348px'?'1fr':'1fr 348px'; }
});

function canvasDown(e){
  const [x,y]=screenToPct(e.clientX,e.clientY);
  if(state.mode==='draw-district'){
    if(!state.drawing){ state.drawing={kind:'district',points:[[x,y]]}; drawGhost(); }
    else{ state.drawing.points.push([x,y]); drawGhost(); }
  } else if(state.mode==='draw-road'){
    if(!state.drawing){ state.drawing={kind:'road',points:[[x,y]]}; drawGhost(true); }
    else{ state.drawing.points.push([x,y]); drawGhost(true); }
  }
}
function drawGhost(isRoad=false){
  // show current in progress
  const pts = state.drawing.points.map(([x,y])=>[x*W/100,y*H/100].join(',')).join(' ');
  hLayer.innerHTML='';
  const el = isRoad
    ? mk('polyline',{class:'road avenue ghost',points:pts,strokeWidth:6})
    : mk('polygon',{class:'district ghost',points:pts});
  hLayer.append(el);
}
function finishDrawing(){
  if(!state.drawing) return;
  // minimal vertices
  if(state.drawing.points.length < (state.drawing.kind==='road'?2:3)){ cancelDrawing(); return;}
  if(state.drawing.kind==='district'){
    const id=prompt('New district id (e.g., custom-1):','custom-'+Math.floor(Math.random()*999));
    const name=prompt('District name:','Custom District');
    MODEL.districts[id]={id,name,desc:'',points:state.drawing.points};
    select('district',id);
  }else{
    const id=prompt('Road id:','road-'+Math.floor(Math.random()*999));
    const name=prompt('Road name:','Unnamed Road');
    const type=(prompt('Type: avenue/street/canal','street')||'street').toLowerCase();
    const width=parseInt(prompt('Width (px)','6'),10)||6;
    MODEL.roads.push({id,name,type,width,points:state.drawing.points});
    select('road',MODEL.roads.length-1);
  }
  state.drawing=null; drawAll();
}
function cancelDrawing(){ state.drawing=null; drawAll(); }

/* =================== Tooltip =================== */
function showTip(evt,obj){
  tip.hidden=false; tip.innerHTML=`<h3>${obj.name||obj.id||'Item'}</h3><p>${obj.desc||''}</p>`;
  moveTip(evt);
}
function moveTip(evt){
  const r=svg.getBoundingClientRect();
  tip.style.left=(evt.clientX-r.left+10)+'px';
  tip.style.top=(evt.clientY-r.top+10)+'px';
}
function hideTip(){ tip.hidden=true; }

/* =================== Form / props =================== */
function updateForm(){
  const sel=state.selected;
  $('#selNone').hidden=!!sel; $('#selForm').hidden=!sel;
  if(!sel) return;
  const obj = sel.kind==='district' ? MODEL.districts[sel.key]
            : sel.kind==='road' ? MODEL.roads[sel.key]
            : MODEL.poi[sel.key];
  $('#sType').value = sel.kind;
  $('#sId').value   = obj.id ?? sel.key;
  $('#sName').value = obj.name ?? '';
  $('#sDesc').value = obj.desc ?? '';
  const isRoad = sel.kind==='road';
  $('#roadExtras').hidden = !isRoad;
  if(isRoad){ $('#sRoadType').value=obj.type||'street'; $('#sRoadW').value=obj.width||6; }
}
$('#apply').addEventListener('click',()=>{
  if(!state.selected) return;
  const sel=state.selected;
  if(sel.kind==='district'){
    const d=MODEL.districts[sel.key];
    delete MODEL.districts[sel.key];
    const newId=$('#sId').value.trim()||sel.key;
    MODEL.districts[newId]={...d,id:newId,name:$('#sName').value,desc:$('#sDesc').value};
    select('district',newId);
  } else if(sel.kind==='road'){
    const r=MODEL.roads[sel.key];
    r.id=$('#sId').value; r.name=$('#sName').value; r.desc=$('#sDesc').value;
    r.type=$('#sRoadType').value; r.width=parseInt($('#sRoadW').value,10)||6;
  } else { // poi
    const p=MODEL.poi[sel.key];
    p.id=$('#sId').value; p.name=$('#sName').value; p.desc=$('#sDesc').value;
  }
  drawAll();
});
$('#delete').addEventListener('click',()=>{
  if(!state.selected) return;
  const s=state.selected;
  if(!confirm('Delete selected '+s.kind+'?')) return;
  if(s.kind==='district') delete MODEL.districts[s.key];
  if(s.kind==='road') MODEL.roads.splice(s.key,1);
  if(s.kind==='poi') MODEL.poi.splice(s.key,1);
  state.selected=null; drawAll();
});

/* =================== Export / Import =================== */
function dumpJSON(){ out.value = JSON.stringify(MODEL,null,2); }
$('#copyJson').addEventListener('click',()=>{ navigator.clipboard.writeText(out.value); });
$('#downloadJson').addEventListener('click',()=> download('konoha-map.json', out.value));
$('#exportSvg').addEventListener('click',()=>{
  const svgStr = buildExportSVG();
  download('konoha-overlay.svg', svgStr, 'image/svg+xml');
});
$('#importFile').addEventListener('change',async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const text=await file.text();
  try{
    const data=JSON.parse(text);
    MODEL.districts=data.districts || {};
    MODEL.roads = data.roads || [];
    MODEL.poi   = data.poi   || MODEL.poi;
    drawAll();
  }catch(err){ alert('Invalid JSON'); }
});
$('#loadAutosave').addEventListener('click',()=>{
  const txt=localStorage.getItem('konoha-map'); if(!txt){ alert('No autosave found'); return; }
  try{ const data=JSON.parse(txt); MODEL.districts=data.districts||{}; MODEL.roads=data.roads||[]; MODEL.poi=data.poi||MODEL.poi; drawAll(); }
  catch{ alert('Autosave corrupt'); }
});
$('#clearAll').addEventListener('click',()=>{
  if(!confirm('Clear all districts & roads?')) return;
  MODEL.roads=[]; MODEL.districts={}; drawAll();
});

/* Build SVG overlay (roads + districts + poi) */
function buildExportSVG(){
  const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const dPolys = Object.values(MODEL.districts).map(d=>{
    const pts=d.points.map(([x,y])=>[x*W/100,y*H/100].join(',')).join(' ');
    return `<polygon points="${pts}" fill="#22d3ee55" stroke="#22d3ee" stroke-width="2"/>`;
  }).join('\n');
  const dRoads = MODEL.roads.map(r=>{
    const pts=r.points.map(([x,y])=>[x*W/100,y*H/100].join(',')).join(' ');
    const col = r.type==='avenue'?'#f8fafc':(r.type==='canal'?'#38bdf8':'#cbd5e1');
    return `<polyline points="${pts}" fill="none" stroke="${col}" stroke-width="${r.width||6}" stroke-linecap="round" stroke-linejoin="round"/>`;
  }).join('\n');
  const dPins = MODEL.poi.map(p=>{
    const r = p.type==='gate'?18:(p.type==='park'?22:(p.type==='letter'?24:22)); // scaled to px
    const cx=p.x*W/100, cy=p.y*H/100;
    const fill = p.type==='gate'?'#ef4444':(p.type==='park'?'#22c55e':(p.type==='letter'?'#a78bfa':'#f59e0b'));
    return `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${fill}" stroke="#000" stroke-width="1.1"><title>${esc(p.name||p.id||'')}</title></circle>`;
  }).join('\n');
  return `<?xml version="1.0" encoding="UTF-8"?>
<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
${dRoads}
${dPolys}
${dPins}
</svg>`;
}

/* =================== UI wiring =================== */
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change',e=>{
  state.mode=e.target.value; state.drawing=null; drawAll();
}));
$('#edit').addEventListener('change',e=>{ state.edit=e.target.checked; drawAll(); });
$('#snap').addEventListener('change',e=>{ state.snap=e.target.checked; });
$('#toggleDistricts').addEventListener('change',drawAll);
$('#toggleRoads').addEventListener('change',drawAll);
$('#togglePOI').addEventListener('change',drawAll);

/* =================== Go =================== */
drawAll();
</script>
</body>
</html>
